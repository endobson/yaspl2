#:module (tools aspect-clean-up-imports-main)
#:import {
  (bytes)
  (compiler)
  (either)
  (io)
  (list)
  (maybe)
  (module-name)
  (prim)
  (set)
  (source-language)
  (tools linter)
  (tools rewrite-imports)
  (unused-bindings)
}
(export
  (#:values main))
(types)

(define (handle-failure-result [msg : Bytes] [stderr : OutputPort]) : Int
  (begin
    (write-line msg stderr)
    1))

(define (handle-result [output : OutputPort] [stderr : OutputPort]
                       [results : (Either Bytes Bytes)]) : Int
  (case results
    [(left v)
     (handle-failure-result v stderr)]
    [(right new-contents)
     (begin
       (write-all-bytes new-contents output)
       0)]))

(define (run [module-file : Bytes] [signature-files : (List Bytes)])
  : (Either Bytes Bytes)
  (case (lint-module module-file signature-files)
    [(left v) (left v)]
    [(right (lint-results _ (unused-bindings all-unused-bindings _ _) _ _ _))
     (case (parse-module-file module-file)
       [(left v) (left (parser-error->bytes v))]
       [(right mod)
        (match-define new-imports
          (filter-map
            (lambda ([imports : Imports]) : (Maybe Imports)
              (let ([imports-mod-name (imports-module-name imports)])
                (case (findf (lambda ([unused : ImportsUnusedBindings])
                               (case unused
                                 [(full-imports-unused unused-mod-name)
                                  (mod-name=? imports-mod-name unused-mod-name)]
                                 [(partial-imports-completely-unused unused-mod-name)
                                  (mod-name=? imports-mod-name unused-mod-name)]
                                 [(partial-imports-unused unused-mod-name _ _ _ _)
                                  (mod-name=? imports-mod-name unused-mod-name)]))
                             all-unused-bindings)
                  [(nothing)
                   (just imports)]
                  [(just (partial-imports-unused _ unused-types unused-values unused-patterns
                                                 unused-statics))
                   (match-define unused-types (set-add-all (make-set bytes-cmp) unused-types))
                   (match-define unused-values (set-add-all (make-set bytes-cmp) unused-values))
                   (match-define unused-patterns (set-add-all (make-set bytes-cmp) unused-patterns))
                   (match-define unused-statics (set-add-all (make-set bytes-cmp) unused-statics))
                   (case imports
                     [(full-imports _)
                      (panic #"Cannot have partially unused full-imports")]
                     [(partial-imports m types values patterns statics)
                      (match-define filter-unused-imports
                        (lambda ([unused : (Set Bytes)] [imports : (List Import)])
                          (filter
                            (lambda ([import : Import])
                              (case import
                                [(import _ local-name)
                                 (not (set-member? unused local-name))]))
                            imports)))
                      (just
                        (partial-imports
                          m
                          (filter-unused-imports unused-types types)
                          (filter-unused-imports unused-values values)
                          (filter-unused-imports unused-patterns patterns)
                          (filter-unused-imports unused-statics statics)))])]
                  [(just (partial-imports-completely-unused _))
                   (nothing)]
                  [(just (full-imports-unused _))
                   (nothing)])))
            (module-imports mod)))
        (rewrite-imports (module-name mod) new-imports module-file)])]))

(define (main [args : Bytes] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]) : Int
  (case (args->list args)
    [(empty)
     (handle-failure-result #"No binary!?" stderr)]
    [(cons _ (empty))
     (handle-failure-result #"No module file provided." stderr)]
    [(cons _ (cons module-file signature-files))
     (handle-result stdout stderr
       (run module-file signature-files))]))
