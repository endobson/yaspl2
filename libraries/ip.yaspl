(module ip
  (import
    (prim
      #:types (Bytes Byte)
      #:values (panic)
      #:patterns ())
    (numbers integer->decimal-bytes decimal-bytes->integer)
    (bytes bytes-append)
    (list
      #:types (List)
      #:values (list)
      #:patterns (cons empty))
    (maybe
      #:types (Maybe)
      #:values (just nothing)
      #:patterns (just nothing))
    (regexp
      #:types (Regexp)
      #:values (epsilon-regexp lit-regexp group-regexp seq-regexp alt-regexp regexp-match
                digit-regexp)
      #:patterns ()))
  (export
    #:types (Ipv4Address)
    #:values (ipv4-address ipv4-address-octet1 ipv4-address-octet2 ipv4-address-octet3 ipv4-address-octet4
              ipv4-address->bytes bytes->ipv4-address)
    #:patterns ())
  (types
    (define-type Ipv4Address
      (ipv4-address [octet1 Byte] [octet2 Byte] [octet3 Byte] [octet4 Byte])))

  (define (ipv4-address->bytes [addr : Ipv4Address]) : Bytes
    (bytes-append
      (varargs list
        (integer->decimal-bytes (ipv4-address-octet1 addr))
        #"."
        (integer->decimal-bytes (ipv4-address-octet2 addr))
        #"."
        (integer->decimal-bytes (ipv4-address-octet3 addr))
        #"."
        (integer->decimal-bytes (ipv4-address-octet4 addr)))))

  (define (octet-regexp) : Regexp
    (seq-regexp
      (digit-regexp)
      (alt-regexp
        (epsilon-regexp)
        (seq-regexp
          (digit-regexp)
          (alt-regexp
            (epsilon-regexp)
            (digit-regexp))))))

  (define (dot-regexp) : Regexp
    (lit-regexp 46))

  (define (ip-regexp) : Regexp
    (seq-regexp
      (group-regexp (octet-regexp))
      (seq-regexp
        (dot-regexp)
        (seq-regexp
          (group-regexp (octet-regexp))
          (seq-regexp
            (dot-regexp)
            (seq-regexp
              (group-regexp (octet-regexp))
              (seq-regexp
                (dot-regexp)
                (group-regexp (octet-regexp)))))))))

  (define (bytes->ipv4-address [bytes : Bytes]) : (Maybe Ipv4Address)
    (case (regexp-match (ip-regexp) bytes)
      [(nothing) (nothing)]
      [(just (cons _ (cons octet1 (cons octet2 (cons octet3 (cons octet4 (empty)))))))
       (just
         (ipv4-address
           (decimal-bytes->integer octet1)
           (decimal-bytes->integer octet2)
           (decimal-bytes->integer octet3)
           (decimal-bytes->integer octet4)))]
      [(just _)
       (panic #"bytes->ipv4-address wrong number of matches")])))
