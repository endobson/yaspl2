(module environment
  (import
    (prim
      #:types (Bytes Byte)
      #:values (panic)
      #:patterns ())
    (bytes bytes-append)
    (list
      #:types ()
      #:values (cons empty)
      #:patterns ())
    (maybe
      #:types (Maybe)
      #:values ()
      #:patterns (just nothing))
    (dict
      #:types (Dict)
      #:values (dict-ref dict-set)
      #:patterns ()))
  (export
    #:types (Environment VariantInfo VarReference)
    #:values (local-var global-value global-value-name free-var
              environment environment-tag-ref environment-value-ref environment-value-set
              variant-info)
    #:patterns (local-var free-var global-value))
  (types
    (define-type Environment
      (environment
        (value-bindings (Dict Bytes VarReference))
        (variant-bindings (Dict Bytes VariantInfo))))
    (define-type VariantInfo
      (variant-info [tag Byte]))
    (define-type VarReference
      (local-var)
      (free-var [offset Byte])
      (global-value [name Bytes])))
  (define (environment-value-ref [env : Environment] [name : Bytes]) : (Maybe VarReference)
    (dict-ref (environment-value-bindings env) name))
  (define (environment-value-set [env : Environment] [name : Bytes] [val : VarReference])
    : Environment
    (case env
      [(environment vals variants)
       (environment (dict-set vals name val) variants)]))
  (define (environment-tag-ref [env : Environment] [name : Bytes]) : Byte
    (case (dict-ref (environment-variant-bindings env) name)
      [(nothing) (panic (bytes-append (cons #"No variant-information for: " (cons name (empty)))))]
      [(just tag) (variant-info-tag tag)]))
)
