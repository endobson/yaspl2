(module prim-language-demo
  (import
    (either
      #:types ()
      #:values ()
      #:patterns (left right))
    (io call-with-input-file newline read-all-bytes write-all-bytes write-line)
    (list
      #:types ()
      #:values (array->list for-each map)
      #:patterns (cons empty))
    (live-variables live-variables print-blocks)
    (prim
      #:types (Array Bytes InputPort Int OutputPort)
      #:values ()
      #:patterns ())
    (prim-language
      #:types ()
      #:values ()
      #:patterns (module))
    (prim-language-parser parse-module)
    (prim-to-register convert-function)
    (print-register-language print-function)
    (register-language
      #:types ((FunctionDefinition r:FunctionDefinition))
      #:values ()
      #:patterns ())
    (sexp-parser parse-sexp))
  (export)
  (types)


  (define (main [args : (Array Bytes)] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]): Int
    (case (array->list args)
      [(empty)
       (begin
         (write-line #"No executable???" stderr)
         1)]
      [(cons _ (empty))
       (begin
         (write-line #"No file name provided." stderr)
         1)]
      [(cons _ (cons _ (cons _ _)))
       (begin
         (write-line #"Too many arguments." stderr)
         1)]
      [(cons _ (cons file-name (empty)))
       (let ([file-bytes (call-with-input-file file-name read-all-bytes)])
         (case (parse-sexp file-bytes)
           [(left v)
            (begin
              (write-line v stderr)
              1)]
           [(right sexp)
            (case (parse-module sexp)
              [(left v)
               (begin
                 (write-line v stderr)
                 1)]
              [(right (module name functions))
               (begin
                 (write-all-bytes #"parsed module: " stdout)
                 (write-line name stdout)
                 (for-each
                   (lambda ([f : r:FunctionDefinition])
                     (let ([live (live-variables f)])
                       (begin
                         (write-all-bytes (print-function f) stdout)
                         (write-all-bytes (print-blocks live) stdout)
                         (newline stdout))))
                   (map convert-function functions))
                 0)])]))])))
