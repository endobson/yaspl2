#:module color-graph-test
#:import {
  color-graph {
    #:values
      color-graph
      initial-state
  }
  list {
    #:values
      empty
      list
  }
  lower-x86-64 {
    #:values
      lower-function
      reg=?
  }
  lowered-live-variables {
    #:values
      blocks->live-out-states
      live-variables
  }
  maybe {
    #:values
      nothing
  }
  prim {
    #:types
      Array
      Bytes
      InputPort
      Int
      OutputPort
  }
  prim-language {
    #:types
      FunctionDefinition
    #:values
      function-definition
      int-literal
      return
  }
  prim-to-register {
    #:values
      convert-function
  }
  yunit {
    #:values
      new-test-case
      yunit/main
  }
}
(export)
(types)

(define (simple-function) : FunctionDefinition
  (function-definition #"simple" (empty)
    (varargs list
      (return (int-literal 42)))))

(define (main [args : (Array Bytes)] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]) : Int
  (yunit/main stderr
    (varargs list
      (new-test-case #"color-graph: empty"
        (lambda ()
          (let ([unused (color-graph (initial-state (empty)))])
            (nothing))))
      (new-test-case #"color-graph: simple"
        (lambda ()
         (let ([unused (color-graph
                         (initial-state
                           (blocks->live-out-states
                             (live-variables
                               (lower-function (convert-function (simple-function)))
                               reg=?))))])
            (nothing)))))))
