#:module (os msabi)
#:import {
  (join-list)
  (list)
  (prim)
  (yaspl x86-64-assembly)
}
(export
  (#:values make-function-fragments make-data-fragments))
(types)


(define (make-function-fragments) : (List TextFragment)
  (varargs list
    (function-fragment
      #"cma0"
      (varargs append-jl*
        (named-block #"cma0_0"
          (varargs join-list
            (pushq (r64mi-reg (rbp)))
            (movq (r64mi-reg (rsp)) (r64m-reg (rbp)))
            ;; Shadow space
            (subq (imm64/s32 32) (rsp))
            (call/indirect (r64m-reg (rdi)))
            (addq (imm64/s32 32) (r64m-reg (rsp)))

            (popq (r64m-reg (rbp)))
            (ret)))))
    (function-fragment
      #"cma1"
      (varargs append-jl*
        (named-block #"cma0_0"
          (varargs join-list
            (pushq (r64mi-reg (rbp)))
            (movq (r64mi-reg (rsp)) (r64m-reg (rbp)))
            ;; Shadow space
            (subq (imm64/s32 32) (rsp))
            (movq (r64mi-reg (rsi)) (r64m-reg (rcx)))
            (call/indirect (r64m-reg (rdi)))
            (addq (imm64/s32 32) (r64m-reg (rsp)))

            (popq (r64m-reg (rbp)))
            (ret)))))))

(define (make-data-fragments) : (List ConstFragment)
  (varargs list
    ;; TODO Make this less hacky
    (const-fragment
      #"cma0c" 3
      (varargs list
        (bytes-fragment (make-bytes 8))
        (address-fragment #"cma0" 0)))
    (const-fragment
      #"cma1c" 3
      (varargs list
        (bytes-fragment (make-bytes 8))
        (address-fragment #"cma1" 0)))
    (const-fragment
      #"yprim_trivial_closure_variant_descriptor" 8
      (varargs list (bytes-fragment (make-bytes 8))))))
