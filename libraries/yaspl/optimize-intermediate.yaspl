#:module (yaspl optimize-intermediate)
#:import {
  (dict)
  (intermediate-expression)
  (intermediate-language)
  (list)
  (maybe)
  (module-signature)
  (prim)
  (top-level-name)
}
(export
  #:types ()
  #:values (optimize-intermediate-module)
  #:patterns ())
(types
  (define-type OptimizeEnvironment
    (optimize-environment
      [inlineable : (Dict TopLevelName InlineableFunction)]
      [known-functions : (Dict TopLevelName TopLevelName)])))

(define (make-optimize-environment [mod : Module]) : OptimizeEnvironment
  (optimize-environment
    (add-all-imported-inlineable-functions
      (make-dict top-level-name-cmp)
      mod)
    (add-all-defined-known-functions
      (add-all-imported-known-functions
        (make-dict top-level-name-cmp)
        mod)
      mod)))

(define (add-all-imported-inlineable-functions
          [env : (Dict TopLevelName InlineableFunction)]
          [mod : Module])
  : (Dict TopLevelName InlineableFunction)
  (match-define (imports static-info) (module-imports mod))
  (dict-fold
    static-info
    (lambda ([k : TopLevelName] [v : TopLevelSignature] [env : (Dict TopLevelName InlineableFunction)])
      (case v
        [(top-level-signature _ inlineable)
         (case inlineable
           [(just inline) (dict-add env k inline)]
           [(nothing) env])]))
    env))

(define (add-all-defined-known-functions [env : (Dict TopLevelName TopLevelName)] [mod : Module])
  : (Dict TopLevelName TopLevelName)
  (match-define mod-name (module-name mod))
  (foldl
    (lambda ([constant : ConstantDefinition] [acc : (Dict TopLevelName TopLevelName)])
      (case constant
        [(closure-constant name fun-name)
         (dict-add acc (top-level-name mod-name name) (top-level-name mod-name fun-name))]
        [(bytes-constant _ _)
         acc]
        [(trivial-variant-constant _ _)
         acc]))
    (module-constants mod)
    env))

(define (add-all-imported-known-functions [env : (Dict TopLevelName TopLevelName)] [mod : Module])
  : (Dict TopLevelName TopLevelName)
  (match-define (imports static-info) (module-imports mod))
  (dict-fold
    static-info
    (lambda ([k : TopLevelName] [v : TopLevelSignature] [env : (Dict TopLevelName TopLevelName)])
      (case v
        [(top-level-signature known _)
         (case known
           [(just known)
            ;; There might be multiple imports for the same symbol so use set instead of add
            (dict-set env k known)]
           [(nothing) env])]))
    env))

(define (optimize-intermediate-module [mod : Module]) : Module
  (match-define (module name imports exports definitions constants) mod)
  (module name imports exports
          (optimize-function-definitions definitions (make-optimize-environment mod))
          constants))

(define (optimize-function-definitions [functions : (List FunctionDefinition)]
                                       [env : OptimizeEnvironment])
  : (List FunctionDefinition)
  (map
    (lambda ([f : FunctionDefinition]) (optimize-function-definition f env))
    functions))

(define (optimize-function-definition [function : FunctionDefinition]
                                      [env : OptimizeEnvironment])
  : FunctionDefinition
  (match-define (function-definition name type args free-vars body) function)
  (function-definition name type args free-vars (optimize-expr body env)))


(define (optimize-expr [expr : Expression] [env : OptimizeEnvironment]) : Expression
  (match-define recur (lambda ([e : Expression]) (optimize-expr e env)))
  (match-define recur-clause (lambda ([c : CaseClause]) (optimize-clause c env)))
  (case expr
    [(int-literal _) expr]
    [(boolean-literal _) expr]
    [(local-var-expr _) expr]
    [(global-var-expr _) expr]
    [(if-expr c t f)
     (if-expr (recur c) (recur t) (recur f))]
    [(begin-expr exprs last-expr)
     (begin-expr (map recur exprs) (recur last-expr))]
    [(create-closure-expr fun-name args)
     (create-closure-expr fun-name (map recur args))]
    [(call-closure-expr tail-position op args)
     (case (expr->known-function op env)
       [(just fun-name)
        (recur (call-function-expr tail-position fun-name args))]
       [(nothing)
        (call-closure-expr tail-position (recur op) (map recur args))])]
    [(call-function-expr tail-position fun-name args)
     (match-define opt-args (map recur args))
     (case (dict-ref (optimize-environment-inlineable env) fun-name)
       [(just (hoas-linear-inlineable-function f))
        (f opt-args)]
       [(nothing)
        (call-function-expr tail-position fun-name opt-args)])]
    [(let-expr name expr body)
     (let-expr name (recur expr) (recur body))]
    [(case-expr expr clauses)
     (case-expr (recur expr) (map recur-clause clauses))]
    [(array-expr args)
     (array-expr (map recur args))]
    [(make-array-expr size expr)
     (make-array-expr (recur size) (recur expr))]
    [(array-length-expr arr)
     (array-length-expr (recur arr))]
    [(array-ref-expr arr off)
     (array-ref-expr (recur arr) (recur off))]
    [(array-set!-expr arr off val)
     (array-set!-expr (recur arr) (recur off) (recur val))]
    [(bytes-length-expr bytes)
     (bytes-length-expr (recur bytes))]
    [(bytes-ref-expr bytes off)
     (bytes-ref-expr (recur bytes) (recur off))]
    [(bytes-set!-expr bytes off val)
     (bytes-set!-expr (recur bytes) (recur off) (recur val))]
    [(prim-numeric-bin-op op l r)
     (prim-numeric-bin-op op (recur l) (recur r))]
    [(prim-comparison-bin-op op l r)
     (prim-comparison-bin-op op (recur l) (recur r))]
    [(prim-logical-bin-op op l r)
     (prim-logical-bin-op op (recur l) (recur r))]
    [(prim-logical-unary-op op e)
     (prim-logical-unary-op op (recur e))]
    [(make-variant-expr tag exprs)
     (make-variant-expr tag (map recur exprs))]
    [(variant-field-ref-expr expr index)
     (variant-field-ref-expr (recur expr) index)]
    [(no-op-cast-op src dest e)
     (no-op-cast-op src dest e)]))

(define (optimize-clause [clause : CaseClause] [env : OptimizeEnvironment]) : CaseClause
  (case clause
    [(case-clause pattern expr)
     (case-clause pattern (optimize-expr expr env))]))

(define (expr->known-function [expr : Expression] [env : OptimizeEnvironment]) : (Maybe TopLevelName)
  (case expr
    [(global-var-expr v)
     (dict-ref (optimize-environment-known-functions env) v)]
    [_ (nothing)]))
