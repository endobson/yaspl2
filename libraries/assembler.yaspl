#:module (assembler)
#:import {
  (aligned-bytes)
  (bytes)
  (join-list)
  (list)
  (maybe)
  (numbers)
  (prim)
  (set)
  (structured-mach-o)
  (tuples)
  (yaspl x86-64-assembly)
  (yaspl x86-64-instruction-assembler)
}
(export
  #:types ()
  #:values (assemble-text-segment assemble-text-section assemble-const-section)
  #:patterns ())
(types
  (define-type EMCCommand
    (emc-mc [command : MCCommand])
    (emc-global-symbol [name : Bytes])
    (emc-local-symbol [name : Bytes])))

(define (assemble-text-segment [fragments : AssemblyFragments])
  : (Tuple2 TextSegmentSection TextSegmentSection)
  (match-define (assembly-fragments text-fragments const-fragments) fragments)
  (tuple2
    (assemble-text-section text-fragments)
    (assemble-const-section const-fragments)))


(define (assemble-text-commands [commands : (List EMCCommand)]) : Bytes
  (bytes-append
    (map
      (lambda ([command : EMCCommand]) : Bytes
        (case command
          [(emc-mc (mc-bytes bytes)) bytes]
          [(emc-mc (mc-branch-relocation symbol)) #"\x00\x00\x00\x00"]
          [(emc-mc (mc-signed-relocation symbol)) #"\x00\x00\x00\x00"]
          [(emc-global-symbol name) #""]
          [(emc-local-symbol name) #""]))
      commands)))

(define (fragments->mc-commands [fragments : (List TextFragment)]) : (List EMCCommand)
  (jl->list
    (concat-map-jl
      (lambda ([fragment : TextFragment]) : (JoinList EMCCommand)
        (case fragment
          [(function-fragment fun-name sections)
           (cons-jl
             (emc-global-symbol fun-name)
             (concat-map-jl
               (lambda ([s : Section])
                 (case s
                   [(section blocks)
                    (concat-map-jl
                      (lambda ([bb : BasicBlock])
                        (case bb
                          [(basic-block block-name instructions)
                           (cons-jl
                             (emc-local-symbol block-name)
                             (map-jl emc-mc (concat-map-jl instruction->mc-commands instructions)))]))
                      (list->jl blocks))]))
               (list->jl sections)))]))
      (list->jl fragments))))

(define (compute-text-section-relocations [commands : (List EMCCommand)])
  : (List Relocation)
  (compute-text-section-relocations* commands (empty) 0))

(define (compute-text-section-relocations*
          [commands : (List EMCCommand)]
          [acc : (List Relocation)]
          [offset : Int])
  : (List Relocation)
  (case commands
    [(empty) acc]
    [(cons command commands)
     (case command
       [(emc-mc (mc-bytes bytes))
        (compute-text-section-relocations* commands acc (+ (bytes-length bytes) offset))]
       [(emc-mc (mc-branch-relocation name))
        (compute-text-section-relocations*
          commands
          (cons (relocation (branch-relocation) offset name) acc)
          (+ offset 4))]
       [(emc-mc (mc-signed-relocation name))
        (compute-text-section-relocations*
          commands
          (cons (relocation (signed-relocation) offset name) acc)
          (+ offset 4))]
       [(emc-global-symbol name)
        (compute-text-section-relocations* commands acc offset)]
       [(emc-local-symbol name)
        (compute-text-section-relocations* commands acc offset)])]))


(define (collect-global-symbols [commands : (List EMCCommand)]) : (Set Bytes)
  (set-add-all
    (make-set bytes-cmp)
    (filter-map
      (lambda ([c : EMCCommand]) : (Maybe Bytes)
        (case c
          [(emc-global-symbol name) (just name)]
          [_ (nothing)]))
      commands)))

(define (collect-defined-text-symbols [commands : (List EMCCommand)])
  : (List DefinedSymbol)
  (collect-defined-text-symbols* commands 0 (empty)))


(define (collect-defined-text-symbols*
          [commands : (List EMCCommand)]
          [text-offset : Int]
          [acc : (List DefinedSymbol)])
  : (List DefinedSymbol)
  (case commands
    [(empty) acc]
    [(cons (emc-mc (mc-bytes bytes)) commands)
     (collect-defined-text-symbols*
       commands
       (+ text-offset (bytes-length bytes))
       acc)]
    [(cons (emc-mc (mc-branch-relocation _)) commands)
     (collect-defined-text-symbols*
       commands
       (+ text-offset 4)
       acc)]
    [(cons (emc-mc (mc-signed-relocation _)) commands)
     (collect-defined-text-symbols*
       commands
       (+ text-offset 4)
       acc)]
    [(cons (emc-global-symbol _) commands)
     (collect-defined-text-symbols*
       commands
       text-offset
       acc)]
    [(cons (emc-local-symbol name) commands)
     (collect-defined-text-symbols*
       commands
       text-offset
       (cons (defined-symbol name text-offset) acc))]))

(define (partition-text-section-relocations
          [relocations : (List Relocation)]
          [local-acc : (List Relocation)]
          [global-acc : (List Relocation)]
          [defined-symbols : (Set Bytes)])
  : (Tuple2 (List Relocation) (List Relocation))
  (case relocations
    [(empty) (tuple2 local-acc global-acc)]
    [(cons reloc relocations)
     (match-define local (set-member? defined-symbols (relocation-symbol reloc)))
     (partition-text-section-relocations
       relocations
       (if local (cons reloc local-acc) local-acc)
       (if local global-acc (cons reloc global-acc))
       defined-symbols)]))

(define (apply-local-text-relocations
          [relocs : (List Relocation)]
          [symbols : (List DefinedSymbol)]
          [text : Bytes]) : Void
  (case relocs
    [(empty) (void)]
    [(cons (relocation _ offset symbol) relocs)
     (begin
        (case (find/maybe (lambda ([x : DefinedSymbol]) : (Maybe Int)
                            (case x
                              [(defined-symbol name offset)
                               (if (bytes=? symbol name)
                                   (just offset)
                                   (nothing))])) symbols)
          [(nothing)
           (panic #"Bad local relocation")]
          [(just symbol-offset)
           (bytes-set!/s32-le
             text
             offset
             (s32 (- (- symbol-offset offset) 4)))])
       (apply-local-text-relocations relocs symbols text))]))

(define (assemble-text-section [text-fragments : (List TextFragment)]) : TextSegmentSection
  (match-define commands (fragments->mc-commands text-fragments))
  (match-define text-section-relocations (compute-text-section-relocations commands))
  (match-define defined-text-symbols
    (collect-defined-text-symbols commands))
  (match-define defined-text-symbol-names
    (set-add-all
      (make-set bytes-cmp)
      (map
        defined-symbol-name
        defined-text-symbols)))
  (match-define text-bytes
    (assemble-text-commands commands))
  (match-define (tuple2 local-text-section-relocations global-text-section-relocations)
    (partition-text-section-relocations text-section-relocations (empty) (empty)
                                        defined-text-symbol-names))
  (match-define global-symbols (collect-global-symbols commands))
  (match-define global-defined-text-symbols
    (filter
      (lambda ([d : DefinedSymbol])
        (case d
          [(defined-symbol name _) (set-member? global-symbols name)]))
      defined-text-symbols))

  (begin
    (apply-local-text-relocations local-text-section-relocations defined-text-symbols text-bytes)
    (text-segment-section
      (aligned-bytes text-bytes 0)
      global-text-section-relocations
      global-defined-text-symbols)))

(define (const-section-fold
          [fragments : (List ConstFragment)]
          [reversed-contents : (List Bytes)]
          [offset : Int]
          [max-alignment : Int]
          [symbols : (List DefinedSymbol)]
          [relocations : (List Relocation)]) : TextSegmentSection
  (case fragments
    [(empty)
     (text-segment-section
       (aligned-bytes (bytes-append (reverse reversed-contents)) max-alignment)
       relocations
       symbols)]
    [(cons (address-fragment name value) fragments)
     (match-define alignment 3)
     (match-define aligned-offset (round-up offset (logical-shift-left 1 alignment)))
     (match-define reversed-contents
       (if (= aligned-offset offset)
           reversed-contents
           (cons (make-bytes (- aligned-offset offset)) reversed-contents)))
     (const-section-fold
       fragments
       (cons (varargs bytes 0 0 0 0 0 0 0 0) reversed-contents)
       (+ aligned-offset 8)
       (max alignment max-alignment)
       (cons (defined-symbol name aligned-offset) symbols)
       (cons (relocation (unsigned-relocation) aligned-offset value) relocations))]
    [(cons (bytes-fragment name value) fragments)
     (const-section-fold
       fragments
       (cons value reversed-contents)
       (+ offset (bytes-length value))
       max-alignment
       (cons (defined-symbol name offset) symbols)
       relocations)]))

(define (assemble-const-section [fragments : (List ConstFragment)]) : TextSegmentSection
  (const-section-fold fragments (empty) 0 0 (empty) (empty)))
