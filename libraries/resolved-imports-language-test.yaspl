#:module (resolved-imports-language-test)
#:import {
  (bytes) {
    #:values
      bytes=?
  }
  (data indexed-set)
  (dict)
  (either) {
    #:patterns
      left
      right
  }
  (list)
  (maybe) {
    #:values
      just
      nothing
    #:patterns
      just
      nothing
  }
  (module-name)
  (module-signature)
  (prim) {
    #:types
      Array
      Bytes
      InputPort
      Int
      OutputPort
  }
  (resolved-imports-language) {
    #:values
      resolve-imports/importss
    #:patterns
      imports
  }
  (source-language) {
    #:values
      full-imports
  }
  (types)
  (yunit)
}
(export)
(types)


(define (main [args : (Array Bytes)] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]): Int
  (yunit/main stderr
    (varargs list
      (new-test-case #"Patterns are resolved in imports"
        (lambda ()
          (case (resolve-imports/importss
                  (cons (full-imports (mod-name (varargs list #"maybe"))) (empty))
                  (indexed-set-add
                    (make-indexed-set module-signature-name mod-name=?)
                    (module-signature
                      (mod-name (varargs list #"maybe"))
                      (make-dict bytes=?)
                      (dict-add
                        (dict-add
                          (make-dict bytes=?)
                          #"just"
                          (pattern-signature
                            #"just" 0 (empty) (var-type #"a") (empty) (type-signature (empty))))
                        #"nothing"
                        (pattern-signature
                          #"nothing" 0 (empty) (var-type #"a") (empty) (type-signature (empty))))
                      (make-dict bytes=?)
                      (make-dict bytes=?)))
                  (make-dict bytes=?)
                  (make-dict bytes=?)
                  (make-dict bytes=?)
                  (empty)
                  (empty)
                  (empty)
                  (empty))
            [(left v)
             (just (failure #"failed"))]
            [(right (imports types values patterns))
             (case (dict-ref patterns #"just")
               [(nothing)
                (just (failure #"No import of just"))]
               [(just _)
                (nothing)])
             ]))))))
