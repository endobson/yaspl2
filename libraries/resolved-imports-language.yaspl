#:module (resolved-imports-language)
#:import {
  (bytes) {
    #:values
      bytes-append
      bytes=?
  }
  (dict) {
    #:types
      Dict
    #:values
      dict-fold
      dict-maybe-add
      dict-ref
      make-dict
  }
  (either) {
    #:types
      Either
    #:values
      left
      right
    #:patterns
      left
      right
  }
  (join-list) {
    #:types
      JoinList
    #:values
      append-jl
      append-jl*
      concat-jl
      empty-jl
      jl->list
      join-list
  }
  (list) {
    #:types
      List
    #:values
      cons
      empty
      findf
      list
      map
    #:patterns
      cons
      empty
  }
  (maybe) {
    #:types
      Maybe
    #:patterns
      just
      nothing
  }
  (module-name) {
    #:types
      ModName
    #:values
      mod-name->bytes
      mod-name=?
  }
  (module-signature) {
    #:types
      ModuleSignature
      PatternSignature
      ValueSignature
    #:values
      module-signature-name
    #:patterns
      module-signature
  }
  (prim) {
    #:types
      Bytes
  }
  (source-language) {
    #:types
      Exports
      FunctionDefinition
      Import
      [Imports s:Imports]
      [Module s:Module]
      TypeDefinition
    #:patterns
      [full-imports s:full-imports]
      import
      [module s:module]
      [partial-imports s:partial-imports]
  }
  (tuples) {
    #:types
      Tuple2
      Tuple3
    #:values
      tuple2
      tuple3
    #:patterns
      tuple2
      tuple3
  }
  (types) {
    #:types
      Type
  }
}
(export
  #:types (Imports Module)
  #:values (resolve-imports import-resolution-errors->bytes
            module-definitions module-name module-types)
  #:patterns (imports module))
(types
  (define-type Module
    (module [name : ModName]
            [imports : Imports]
            [exports : Exports]
            [types : (List TypeDefinition)]
            [definitions : (List FunctionDefinition)]))
  (define-type Imports
    (imports
      [types : (Dict Bytes Type)]
      [values : (Dict Bytes ValueSignature)]
      [patterns : (Dict Bytes PatternSignature)]))

  (define-type ImportResolutionErrors
    (import-resolution-errors
      [module-name : ModName]
      [errors : (List ImportResolutionError)]))

  (define-type ImportResolutionError
    (non-existent-imports/module [module-name : ModName])
    (non-existent-imports/bindings
      [module-name : ModName]
      [types : (List Bytes)]
      [values : (List Bytes)]
      [patterns : (List Bytes)])
    (duplicate-imports
      [types : (List Bytes)]
      [values : (List Bytes)]
      [patterns : (List Bytes)])))

(define (resolve-imports [mod : s:Module] [sigs : (List ModuleSignature)])
  : (Either ImportResolutionErrors Module)
  (match-define (s:module name importss exports types definitions) mod)
  (case (resolve-imports/importss
          importss sigs (make-dict bytes=?) (make-dict bytes=?) (make-dict bytes=?)
                        (empty) (empty) (empty) (empty))
    [(left errors)
     (left (import-resolution-errors name errors))]
    [(right imports)
     (right (module name imports exports types definitions))]))

(define (resolve-imports/importss
          [importss : (List s:Imports)]
          [sigs : (List ModuleSignature)]
          [types : (Dict Bytes Type)]
          [values : (Dict Bytes ValueSignature)]
          [patterns : (Dict Bytes PatternSignature)]
          [errors : (List ImportResolutionError)]
          [duplicate-types : (List Bytes)]
          [duplicate-values : (List Bytes)]
          [duplicate-patterns : (List Bytes)])
  : (Either (List ImportResolutionError) Imports)
  (case importss
    [(empty)
     (match-define final-errors
       (case (tuple3 duplicate-types duplicate-values duplicate-patterns)
         [(tuple3 (empty) (empty) (empty))
          errors]
         [_
          (cons (duplicate-imports duplicate-types duplicate-values duplicate-patterns)
                errors)]))
     (case final-errors
       [(empty)
        (right (imports types values patterns))]
       [e
        (left e)])]
    [(cons (s:full-imports mod-name) importss)
     (case (find-signature mod-name sigs)
       [(nothing)
        (resolve-imports/importss
          importss sigs types values patterns
          (cons (non-existent-imports/module mod-name) errors)
          duplicate-types duplicate-values duplicate-patterns)]
       [(just (module-signature _ e-values e-patterns e-types _))
        (match-define (tuple2 duplicate-types types)
          (add-all-type-imports e-types types duplicate-types))
        (match-define (tuple2 duplicate-values values)
          (add-all-value-imports e-values values duplicate-values))
        (match-define (tuple2 duplicate-patterns patterns)
          (add-all-pattern-imports e-patterns patterns duplicate-patterns))
        (resolve-imports/importss
          importss sigs types values patterns errors
          duplicate-types duplicate-values duplicate-patterns)])]
    [(cons (s:partial-imports mod-name i-types i-values i-patterns) importss)
     (case (find-signature mod-name sigs)
       [(nothing)
        (resolve-imports/importss
          importss sigs types values patterns
          (cons (non-existent-imports/module mod-name) errors)
          duplicate-types duplicate-values duplicate-patterns)]
       [(just (module-signature _ e-values e-patterns e-types _))
        (match-define (tuple3 unknown-types duplicate-types types)
          (add-type-imports i-types e-types types (empty) duplicate-types))
        (match-define (tuple3 unknown-values duplicate-values values)
          (add-value-imports i-values e-values values (empty) duplicate-values))
        (match-define (tuple3 unknown-patterns duplicate-patterns patterns)
          (add-pattern-imports i-patterns e-patterns patterns (empty) duplicate-patterns))
        (match-define new-errors
          (case (tuple3 unknown-types unknown-values unknown-patterns)
            [(tuple3 (empty) (empty) (empty))
             errors]
            [_
             (cons (non-existent-imports/bindings mod-name unknown-types unknown-values unknown-patterns)
                   errors)]))
        (resolve-imports/importss
          importss sigs types values patterns new-errors
          duplicate-types duplicate-values duplicate-patterns)])]))

(define (add-type-imports
          [imports : (List Import)]
          [exported-types : (Dict Bytes Type)]
          [types : (Dict Bytes Type)]
          [unknown-imports : (List Bytes)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple3 (List Bytes) (List Bytes) (Dict Bytes Type))
  (case imports
    [(empty)
     (tuple3 unknown-imports duplicate-bindings types)]
    [(cons (import ex-name im-name) imports)
     (case (dict-ref exported-types ex-name)
       [(nothing)
        (add-type-imports imports exported-types types (cons ex-name unknown-imports)
                          duplicate-bindings)]
       [(just t)
        (case (dict-maybe-add types im-name t)
          [(nothing)
           (add-type-imports imports exported-types types unknown-imports
                             (cons im-name duplicate-bindings))]
          [(just types)
           (add-type-imports imports exported-types types unknown-imports duplicate-bindings)])])]))

(define (add-value-imports
          [imports : (List Import)]
          [exported-values : (Dict Bytes ValueSignature)]
          [values : (Dict Bytes ValueSignature)]
          [unknown-imports : (List Bytes)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple3 (List Bytes) (List Bytes) (Dict Bytes ValueSignature))
  (case imports
    [(empty)
     (tuple3 unknown-imports duplicate-bindings values)]
    [(cons (import ex-name im-name) imports)
     (case (dict-ref exported-values ex-name)
       [(nothing)
        (add-value-imports imports exported-values values (cons ex-name unknown-imports)
                           duplicate-bindings)]
       [(just t)
        (case (dict-maybe-add values im-name t)
          [(nothing)
           (add-value-imports imports exported-values values unknown-imports
                              (cons im-name duplicate-bindings))]
          [(just values)
           (add-value-imports imports exported-values values unknown-imports duplicate-bindings)])])]))

(define (add-pattern-imports
          [imports : (List Import)]
          [exported-patterns : (Dict Bytes PatternSignature)]
          [patterns : (Dict Bytes PatternSignature)]
          [unknown-imports : (List Bytes)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple3 (List Bytes) (List Bytes) (Dict Bytes PatternSignature))
  (case imports
    [(empty)
     (tuple3 unknown-imports duplicate-bindings patterns)]
    [(cons (import ex-name im-name) imports)
     (case (dict-ref exported-patterns ex-name)
       [(nothing)
        (add-pattern-imports imports exported-patterns patterns (cons ex-name unknown-imports)
                             duplicate-bindings)]
       [(just sig)
        (case (dict-maybe-add patterns im-name sig)
          [(nothing)
           (add-pattern-imports imports exported-patterns patterns unknown-imports
                                (cons im-name duplicate-bindings))]
          [(just patterns)
           (add-pattern-imports imports exported-patterns patterns unknown-imports duplicate-bindings)])])]))

(define (add-all-type-imports
          [exported-types : (Dict Bytes Type)]
          [types : (Dict Bytes Type)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple2 (List Bytes) (Dict Bytes Type))
  (dict-fold
    exported-types
    (lambda ([name : Bytes] [t : Type] [acc : (Tuple2 (List Bytes) (Dict Bytes Type))])
      (case acc
        [(tuple2 duplicate-bindings types)
         (case (dict-maybe-add types name t)
           [(nothing)
            (tuple2 (cons name duplicate-bindings) types)]
           [(just types)
            (tuple2 duplicate-bindings types)])]))
    (tuple2 duplicate-bindings types)))

(define (add-all-value-imports
          [exported-values : (Dict Bytes ValueSignature)]
          [values : (Dict Bytes ValueSignature)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple2 (List Bytes) (Dict Bytes ValueSignature))
  (dict-fold
    exported-values
    (lambda ([name : Bytes]
             [v : ValueSignature]
             [acc : (Tuple2 (List Bytes) (Dict Bytes ValueSignature))])
      (case acc
        [(tuple2 duplicate-bindings values)
         (case (dict-maybe-add values name v)
           [(nothing)
            (tuple2 (cons name duplicate-bindings) values)]
           [(just values)
            (tuple2 duplicate-bindings values)])]))
    (tuple2 duplicate-bindings values)))

(define (add-all-pattern-imports
          [exported-patterns : (Dict Bytes PatternSignature)]
          [patterns : (Dict Bytes PatternSignature)]
          [duplicate-bindings : (List Bytes)])
  : (Tuple2 (List Bytes) (Dict Bytes PatternSignature))
  (dict-fold
    exported-patterns
    (lambda ([name : Bytes]
             [p : PatternSignature]
             [acc : (Tuple2 (List Bytes) (Dict Bytes PatternSignature))])
      (case acc
        [(tuple2 duplicate-bindings values)
         (case (dict-maybe-add patterns name p)
           [(nothing)
            (tuple2 (cons name duplicate-bindings) patterns)]
           [(just patterns)
            (tuple2 duplicate-bindings patterns)])]))
    (tuple2 duplicate-bindings patterns)))

(define (find-signature [name : ModName] [sigs : (List ModuleSignature)]) : (Maybe ModuleSignature)
  (findf (lambda ([sig : ModuleSignature]) (mod-name=? name (module-signature-name sig))) sigs))


(define (import-resolution-errors->bytes [me : ImportResolutionErrors]) : Bytes
  (case me
    [(import-resolution-errors mod-name errors)
     (bytes-append
       (map (lambda ([error : ImportResolutionError]) (import-resolution-error->bytes mod-name error))
            errors))]))

(define (import-resolution-error->bytes [mod-name : ModName] [e : ImportResolutionError]) : Bytes
  (case e
    [(non-existent-imports/module import-name)
     (bytes-append
       (varargs list #"Missing import in " (mod-name->bytes mod-name)
                     #". Could not find module: " (mod-name->bytes import-name) #"\n"))]
    [(non-existent-imports/bindings import-name types values patterns)
     (let ([warn-no-exports
             (lambda ([kind : Bytes] [names : (List Bytes)]) : (JoinList Bytes)
               (case names
                 [(empty) (empty-jl)]
                 [_
                   (append-jl
                     (varargs join-list #"  " kind #" imports:\n")
                     (concat-jl (map (lambda ([name : Bytes])
                                       (varargs join-list #"    " name #"\n"))
                                     names)))]))])
        (bytes-append
          (jl->list
            (append-jl
              (varargs join-list
                #"Undefined imports in module " (mod-name->bytes mod-name) #" from module "
                (mod-name->bytes import-name) #":\n")
              (varargs append-jl*
                (warn-no-exports #"Type" types)
                (warn-no-exports #"Value" values)
                (warn-no-exports #"Pattern" patterns))))))]
    [(duplicate-imports types values patterns)
     (let ([warn-duplicate-imports
             (lambda ([kind : Bytes] [names : (List Bytes)]) : (JoinList Bytes)
               (case names
                 [(empty) (empty-jl)]
                 [_
                   (append-jl
                     (varargs join-list #"  " kind #" imports:\n")
                     (concat-jl (map (lambda ([name : Bytes])
                                       (varargs join-list #"    " name #"\n"))
                                     names)))]))])
        (bytes-append
          (jl->list
            (append-jl
              (varargs join-list
                #"Duplicate imports in module " (mod-name->bytes mod-name) #":\n")
              (varargs append-jl*
                (warn-duplicate-imports #"Type" types)
                (warn-duplicate-imports #"Value" values)
                (warn-duplicate-imports #"Pattern" patterns))))))]))
