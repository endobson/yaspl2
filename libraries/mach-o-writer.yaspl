(module mach-o-writer
  (import
    (prim
      #:types (Bytes Byte InputPort OutputPort Array Void)
      #:values (* + - > < = array-length array-ref open-output-file read-bytes make-bytes
                bytes-length panic void bytes-ref u32)
      #:patterns ())
    (dict
      #:types (Dict)
      #:values ()
      #:patterns ())
    (list
      #:types (List)
      #:values (list length empty)
      #:patterns (cons empty))
    (io write-line write-all-bytes)
    (numbers integer->hex-bytes integer->decimal-bytes)
    (bytes bytes bytes-ref/quad-le bytes-set!/octo-le bytes-set!/quad-le make-null-terminated))
  (export
    #:types ()
    #:values (lc-load-segment64 load-segment64 section64 write-mach-o-header mach-o-header)
    #:patterns ())
  (types
    (define-type MachOHeader
      (mach-o-header [commands (List MachOLoadCommand)]))
    (define-type MachOLoadCommand
      (lc-unix-thread [v UnixThread])
      (lc-source-version)
      (lc-symbol-table [v SymbolTable])
      (lc-load-segment64 [v LoadSegment64]))
    (define-type LoadSegment64
      (load-segment64
        [name Bytes]
        [vm-addr Byte]
        [vm-size Byte]
        [file-offset Byte]
        [file-size Byte]
        [max-protection Byte]
        [init-protection Byte]
        [flags Byte]
        [sections (List Section64)]))

    (define-type Section64
      (section64
        [name Bytes]
        [addr Byte]
        [size Byte]
        [offset Byte]
        [flags Byte]))

    (define-type UnixThread
      (unix-thread
        [start-address Byte]))


    (define-type SymbolTable
      (symbol-table
        [offset Byte]
        [number Byte]
        [string-offset Byte]
        [string-size Byte]))

    (define-type RelocationEntry
      (branch-reloc-entry [name Bytes])
      (unsigned-reloc-entry [name Bytes]))

    (define-type AssemblyBlock
      (assembly-block
        [data Bytes]
        [symbols (Dict Bytes Byte)]
        [relocations (Dict Byte RelocationEntry)])))


  (define (write-quad-le [v : Byte] [output : OutputPort]) : Void
    (let ([bytes (make-bytes 4)])
      (begin
        (bytes-set!/quad-le bytes 0 (u32 v))
        (write-all-bytes bytes output))))

  (define (write-octo-le [v : Byte] [output : OutputPort]) : Void
    (let ([bytes (make-bytes 8)])
      (begin
        (bytes-set!/octo-le bytes 0 v)
        (write-all-bytes bytes output))))


  (define (load-commands-size [lcs : (List MachOLoadCommand)]) : Byte
    (case lcs
      [(empty) 0]
      [(cons lc lcs)
       (+ (load-command-size lc) (load-commands-size lcs))]))

  (define (load-command-size [lc : MachOLoadCommand]) : Byte
    (case lc
      [(lc-unix-thread _) #xb8]
      [(lc-source-version) #x10]
      [(lc-load-segment64 load-seg)
       (+ 72 (* (length (load-segment64-sections load-seg)) 80))]
      [(lc-symbol-table _) #x18]))


  (define (write-mach-o-header [header : MachOHeader] [output : OutputPort]) : Void
    (case header
      [(mach-o-header commands)
       (begin
         (write-quad-le #xfeedfacf output)
         ;; CPU type
         (write-quad-le #x01000007 output)
         ;; CPU subtype
         (write-quad-le #x03 output)
         ;; File type
         (write-quad-le #x02 output)

         ;; Number of commands
         (write-quad-le (length commands) output)
         ;; Size of commands
         (write-quad-le (load-commands-size commands) output)

         ;; Flags
         (write-quad-le #x01  output)
         ;; Reserved
         (write-quad-le #x00 output)

         (write-load-commands commands output))]))

  (define (write-load-commands [commands : (List MachOLoadCommand)] [output : OutputPort]) : Void
    (case commands
      [(empty) (void)]
      [(cons (lc-unix-thread ut) commands)
       (begin
         (write-unix-thread ut output)
         (write-load-commands commands output))]
      [(cons (lc-source-version) commands)
       (begin
         (write-source-version output)
         (write-load-commands commands output))]
      [(cons (lc-load-segment64 ls) commands)
       (begin
         (write-load-segment64 ls)
         (write-load-commands commands output))]
      [(cons (lc-symbol-table st) commands)
       (begin
         (write-symbol-table st output)
         (write-load-commands commands output))]))

  (define (write-16-byte-name [bytes : Bytes] [output : OutputPort]) : Void
    (if (> (bytes-length bytes) 16)
        (panic #"Too Long")
        (begin
          (write-all-bytes bytes output)
          (write-all-bytes (make-bytes (- 16 (bytes-length bytes))) output))))

  (define (write-load-segment64 [seg : LoadSegment64] [output : OutputPort]) : Void
    (case seg
      [(load-segment64 name vm-addr vm-size file-offset file-size max-protection init-protection flags sections)
       (begin
         ;; LC_SEGMENT_64
         (write-quad-le #x19 output)
         ;; Command size
         (write-quad-le (+ 72 (* (length sections) 80)) output)

         (write-16-byte-name name output)

         (write-octo-le vm-addr output)
         (write-octo-le vm-size output)

         (write-octo-le file-offset output)
         (write-octo-le file-size output)

         (write-quad-le max-protection output)
         (write-quad-le init-protection output)
         (write-quad-le (length sections) output)
         (write-quad-le flags output)

         (write-sections name sections output))]))

  (define (write-sections [seg-name : Bytes] [sections : (List Section64)] [output : OutputPort]) : Void
    (case sections
      [(empty) (void)]
      [(cons section sections)
       (begin
         (write-section seg-name section output)
         (write-sections seg-name sections output))]))

  (define (write-section [seg-name : Bytes] [section : Section64] [output : OutputPort]) : Void
    (case section
      [(section64 name addr size offset flags)
       (begin
         (write-16-byte-name name output)
         (write-16-byte-name seg-name output)

         (write-octo-le addr output)
         (write-octo-le size output)
         (write-quad-le offset output)

         (write-quad-le #x00 output)
         (write-quad-le #x00 output)
         (write-quad-le #x00 output)


         (write-quad-le flags output)
         (write-quad-le #x00 output)
         (write-quad-le #x00 output)
         (write-quad-le #x00 output))]))


  (define (write-source-version [output : OutputPort]) : Void
    (begin
      ;; LC_UNIXTHREAD
      (write-quad-le #x2A output)
      ;; Command size
      (write-quad-le #x10 output)

      (write-octo-le #x00 output)))


  (define (write-unix-thread [ut : UnixThread] [output : OutputPort]) : Void
    (case ut
      [(unix-thread start-address)
       (begin
         ;; LC_UNIXTHREAD
         (write-quad-le #x05 output)
         ;; Command size
         (write-quad-le #xb8 output)
         ;; Thread Flavor
         (write-quad-le #x04 output)
         ;; Thread Count
         (write-quad-le #x2a output)

         ;; Registers
         ;; rax
         (write-octo-le #x0000000000000000 output)
         ;; rbx
         (write-octo-le #x0000000000000000 output)
         ;; rcx
         (write-octo-le #x0000000000000000 output)
         ;; rdx
         (write-octo-le #x0000000000000000 output)
         ;; rdi
         (write-octo-le #x0000000000000000 output)
         ;; rsi
         (write-octo-le #x0000000000000000 output)
         ;; rbp
         (write-octo-le #x0000000000000000 output)
         ;; rsp
         (write-octo-le #x0000000000000000 output)
         ;; r8
         (write-octo-le #x0000000000000000 output)
         ;; r9
         (write-octo-le #x0000000000000000 output)
         ;; r10
         (write-octo-le #x0000000000000000 output)
         ;; r11
         (write-octo-le #x0000000000000000 output)
         ;; r12
         (write-octo-le #x0000000000000000 output)
         ;; r13
         (write-octo-le #x0000000000000000 output)
         ;; r14
         (write-octo-le #x0000000000000000 output)
         ;; r15
         (write-octo-le #x0000000000000000 output)

         ;; rip
         (write-octo-le start-address output)
         ;; rflags
         (write-octo-le #x0000000000000000 output)
         ;; cs
         (write-octo-le #x0000000000000000 output)
         ;; fs
         (write-octo-le #x0000000000000000 output)
         ;; gs
         (write-octo-le #x0000000000000000 output))]))

  (define (write-symbol-table [st : SymbolTable] [output : OutputPort]) : Void
    (case st
      [(symbol-table offset number-syms string-offset string-size)
       (begin
         ;; LC_SYMTAB
         (write-quad-le #x02 output)
         ;; Command size
         (write-quad-le #x18 output)

         (write-quad-le offset output)
         (write-quad-le number-syms output)
         (write-quad-le string-offset output)
         (write-quad-le string-size output))]))



  (define (main [args : (Array Bytes)] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]) : Byte
    (if (< (array-length args) 2)
        (begin
          (write-line #"No output file name supplied" stderr)
          1)
        (let ([output (open-output-file (make-null-terminated (array-ref args 1)))])
          (begin
            (write-mach-o-header
              (mach-o-header
                (varargs list
                  (lc-load-segment64
                    (load-segment64 #"__PAGEZERO"
                      #x0000000000000000
                      #x0000000100000000
                      0
                      0
                      0
                      0
                      0
                      (empty)))
                  (lc-load-segment64
                    (load-segment64 #"__TEXT"
                      #x0000000100000000
                      #x0000000000001000
                      0
                      #x1000
                      7
                      5
                      0
                      (empty)))
                  (lc-unix-thread
                    (unix-thread
                      #x0000000100000168))))
              output)
            (write-all-bytes (varargs bytes #x90 #x90) output)

            (write-all-bytes (varargs bytes #x48 #xc7 #xc7 #x03 #x00 #x00 #x00) output) ;   mov    0x3, %rdi
            (write-all-bytes (varargs bytes #x48 #xc7 #xc0 #x01 #x00 #x00 #x02) output) ;    mov    0x2000001, %rax
            (write-all-bytes (varargs bytes #x0f #x05) output)

            (write-all-bytes (make-bytes (- #x1000 362)) output)
            0)))))
