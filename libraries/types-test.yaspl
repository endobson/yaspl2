(module types-test
  (import
    (prim
      #:types (Array Bytes InputPort OutputPort Boolean Int)
      #:values ()
      #:patterns ())
    (maybe
      #:types (Maybe)
      #:values (just nothing)
      #:patterns ())
    (yunit
      #:types (FailedAssertion)
      #:values (yunit/main new-test-case failure)
      #:patterns ())
    (types
      #:types (Type Kind)
      #:values (var-type type=? abstract-type fun-type star-kind type-constructor fun-kind kind=?)
      #:patterns ())
    (list
      #:types ()
      #:values (list empty)
      #:patterns ()))
  (export)
  (types)

  (define (check-types-equal? [t1 : Type] [t2 : Type]) : (-> (Maybe FailedAssertion))
    (lambda ()
      (if (type=? t1 t2)
          (nothing)
          (just (failure #"Unequal types")))))

  (define (check-types-not-equal? [t1 : Type] [t2 : Type]) : (-> (Maybe FailedAssertion))
    (lambda ()
      (if (type=? t1 t2)
          (just (failure #"Equal types"))
          (nothing))))

  (define (check-kinds-equal? [k1 : Kind] [k2 : Kind]) : (-> (Maybe FailedAssertion))
    (lambda ()
      (if (kind=? k1 k2)
          (nothing)
          (just (failure #"Unequal kinds")))))

  (define (check-kinds-not-equal? [k1 : Kind] [k2 : Kind]) : (-> (Maybe FailedAssertion))
    (lambda ()
      (if (kind=? k1 k2)
          (just (failure #"Equal kinds"))
          (nothing))))

  (define (main [args : (Array Bytes)] [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]) : Int
    (yunit/main stderr
      (varargs list
        (new-test-case #"A = A"
          (check-types-equal? (var-type #"A") (var-type #"A")))
        (new-test-case #"A != B"
          (check-types-not-equal? (var-type #"A") (var-type #"B")))
        (new-test-case #"Bytes = Bytes"
          (check-types-equal?
            (abstract-type #"prim" #"Bytes" (empty))
            (abstract-type #"prim" #"Bytes" (empty))))
        (new-test-case #"Bytes != Int"
          (check-types-not-equal?
            (abstract-type #"prim" #"Bytes" (empty))
            (abstract-type #"prim" #"Int" (empty))))
        (new-test-case #"(List Bytes) = (List Bytes)"
          (check-types-equal?
            (abstract-type #"list" #"List"
              (varargs list (abstract-type #"prim" #"Bytes" (empty))))
            (abstract-type #"list" #"List"
              (varargs list (abstract-type #"prim" #"Bytes" (empty))))))
        (new-test-case #"(List Bytes) != (List Int)"
          (check-types-not-equal?
            (abstract-type #"list" #"List"
              (varargs list (abstract-type #"prim" #"Bytes" (empty))))
            (abstract-type #"list" #"List"
              (varargs list (abstract-type #"prim" #"Int" (empty))))))
        (new-test-case #"(-> A) = (-> A)"
          (check-types-equal?
            (fun-type (empty) (var-type #"A"))
            (fun-type (empty) (var-type #"A"))))
        (new-test-case #"(-> A) = (-> B)"
          (check-types-not-equal?
            (fun-type (empty) (var-type #"A"))
            (fun-type (empty) (var-type #"B"))))
        (new-test-case #"(A -> A) = (-> A)"
          (check-types-not-equal?
            (fun-type (varargs list (var-type #"A")) (var-type #"A"))
            (fun-type (empty) (var-type #"A"))))

        (new-test-case #"List = List"
          (check-types-equal?
            (type-constructor #"list" #"List" (varargs list (star-kind)))
            (type-constructor #"list" #"List" (varargs list (star-kind)))))
        (new-test-case #"List = Tuple2"
          (check-types-not-equal?
            (type-constructor #"list" #"List" (varargs list (star-kind)))
            (type-constructor #"tuples" #"Tuple2" (varargs list (star-kind) (star-kind)))))

        (new-test-case #"* = *"
          (check-kinds-equal? (star-kind) (star-kind)))
        (new-test-case #"* != (-> *)"
          (check-kinds-not-equal? (star-kind) (fun-kind (empty) (star-kind))))
        (new-test-case #"(* -> *) = (* -> *)"
          (check-kinds-equal?
            (fun-kind (varargs list (star-kind)) (star-kind))
            (fun-kind (varargs list (star-kind)) (star-kind))))))))
