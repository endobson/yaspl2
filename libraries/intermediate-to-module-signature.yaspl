(module intermediate-to-module-signature
  (import
    (prim
      #:types (Bytes Boolean Byte)
      #:values (panic + * - = > bytes-length bytes-ref bytes-set! make-bytes or)
      #:patterns ())
    (list
      #:types (List)
      #:values (cons empty length append map append* reverse)
      #:patterns (cons empty))
    (bytes bytes=? bytes-append)
    (either
      #:types (Either)
      #:values (right left)
      #:patterns (right left))
    (environment
      #:types (Environment VariantInfo VarReference)
      #:values (global-value-name environment-tag-ref environment-value-ref)
      #:patterns ())
    (dict
      #:types (Dict)
      #:values (make-dict dict-ref dict-add)
      #:patterns ())
    (maybe
      #:types (Maybe)
      #:values ()
      #:patterns (just nothing))
    (tuples
      #:types (Tuple2)
      #:values (tuple2)
      #:patterns (tuple2))
    (join-list
      #:types ()
      #:values (jl->list empty-jl append-jl snoc-jl)
      #:patterns ())
    (intermediate-language
      #:types (Module)
      #:values ()
      #:patterns (module))
    (source-language
      #:types (TypeDefinition VariantDefinition VariantField Exports Export)
      #:values (exports-old-style)
      #:patterns (variant-definition type-definition variant-field export)))
  (export module-signature-name module-signature-value-exports module-signature-pattern-exports
          module-signature module->module-signature)
  (types
    (define-type ModuleSignature
      (module-signature
        [name Bytes]
        [value-exports (Dict Bytes Bytes)]
        [pattern-exports (Dict Bytes Byte)])))


  (define (module->module-signature [mod : Module] [env : Environment]) : ModuleSignature
    (case mod
      [(module name _ exports types _ _ _)
       (module-signature
         name
         (make-exports (exports-old-style exports) env (make-dict bytes=?))
         (make-exported-patterns types env (make-dict bytes=?)))]))

  (define (make-exports [exports : (List Export)] [env : Environment] [acc : (Dict Bytes Bytes)])
    : (Dict Bytes Bytes)
    (case exports
      [(empty) acc]
      [(cons (export local-name exported-name) exports)
       (case (environment-value-ref env local-name)
         ;; TODO handle this case better (seperate out value and type exports)
         [(nothing)
          (make-exports exports env acc)]
         [(just exported-name*)
          (make-exports
            exports
            env
            (dict-add
              acc
              exported-name
              (global-value-name exported-name*)))])]))


  (define (make-exported-patterns
            [types : (List TypeDefinition)]
            [env : Environment]
            [acc : (Dict Bytes Byte)]) : (Dict Bytes Byte)
    (case types
      [(empty) acc]
      [(cons (type-definition _ _ variants) types)
       (make-exported-patterns
         types
         env
         (make-exported-patterns/variants variants env acc))]))

  (define (make-exported-patterns/variants
            [variants : (List VariantDefinition)]
            [env : Environment]
            [acc : (Dict Bytes Byte)]) : (Dict Bytes Byte)
    (case variants
      [(empty) acc]
      [(cons (variant-definition name _) variants)
       (make-exported-patterns/variants
         variants
         env
         (dict-add acc name (environment-tag-ref env name)))]))
  )
