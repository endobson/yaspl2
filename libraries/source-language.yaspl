(module source-language
  (import
    (prim
      #:types (Bytes InputPort OutputPort Byte Boolean)
      #:values (panic)
      #:patterns ())
    (sexp-parser
      #:types (Sexp)
      #:values (parse-sexp)
      #:patterns (node symbol-sexp))
    (io write-all-bytes read-all-bytes)
    (either
      #:types (Either)
      #:values (left right)
      #:patterns (left right))
    (maybe
      #:types (Maybe)
      #:values (just nothing)
      #:patterns ())
    (list
      #:types (List)
      #:values (cons empty map)
      #:patterns (cons empty)))
  (export main)
  (types
    (define-type Module
      (module [name Bytes]
              [imports Imports]
              [exports (List Bytes)]
              [types (List TypeDefinition)]
              [definitions (List FunctionDefinition)]))
    ;; TODO make these have the right substructure
    (define-type Imports
      (unparsed-imports [v Sexp]))
    (define-type TypeDefinition
      (type-definition [name Bytes] [vars (Maybe (List Bytes))] [variants (List VariantDefinition)]))
    (define-type VariantDefinition
      (variant-definition [name Bytes] [fields (List VariantField)]))
    (define-type VariantField
      (variant-field [name Bytes] [type PreType]))
    (define-type PreType
      (var-pre-type [v Bytes])
      (fun-pre-type [type-vars (List Bytes)] [args (List PreType)] [result PreType])
      (type-app-pre-type [constructor Bytes] [args (List PreType)]))
    (define-type FunctionDefinition
      (function-definition [name Bytes] [type PreType] [args (List Bytes)] [body Sexp]))

    (define-type Expression
      (byte-literal [v Byte])
      (bytes-literal [v Bytes])
      (boolean-literal [v Boolean])
      (var-expr [v Bytes])
      (if-expr [cond Expression] [true Expression] [false Expression])
      (begin-expr [first (List Expression)] [last Expression])
      (app-expr [op Expression] [args (List Expression)])
      (let-expr [name Bytes] [expr Expression] [body Expression])
      (case-expr [expr Expression] [clauses (List CaseClause)]))

    (define-type CaseClause
      (case-clause [pattern Pattern] [expr Expression]))

    (define-type Pattern
      (unparsed-pattern [v Sexp])))


  (define (parse-exports/top [sexp : Sexp]) : (List Bytes)
    (case sexp
      [(node (cons (symbol-sexp #"export") exported-symbols))
       (map parse-exported-symbol exported-symbols)]
      [_ (panic #"Bad exports")]))

  (define (parse-exported-symbol [sexp : Sexp]) : Bytes
    (case sexp
      [(symbol-sexp bytes) bytes]
      [_ (panic #"Not a valid export")]))



  (define (parse-types/top [sexp : Sexp]) : (List TypeDefinition)
    (case sexp
      [(node (cons (symbol-sexp #"types") type-definitions))
       (map parse-type-definition type-definitions)]
      [_ (panic #"Bad types")]))

  (define (parse-type-definition [sexp : Sexp]) : TypeDefinition
    (case sexp
      [(node (cons (symbol-sexp #"define-type") (cons type-name/vars variants)))
       (type-definition
         (extract-type-name type-name/vars)
         (extract-type-vars type-name/vars)
         (map parse-variant variants))]
      [_ (panic #"Bad type definition")]))

  (define (parse-variant [sexp : Sexp]) : VariantDefinition
    (case sexp
      [(node (cons (symbol-sexp variant-name) fields))
       (variant-definition variant-name (map parse-variant-field fields))]
      [_ (panic #"Bad variant definition")]))

  (define (parse-variant-field [sexp : Sexp]) : VariantField
    (case sexp
      [(node (cons (symbol-sexp field-name) (cons type (empty))))
       (variant-field field-name (parse-pre-type type))]
      [_ (panic #"Bad variant field")]))

  (define (extract-type-name [sexp : Sexp]) : Bytes
    (case sexp
      [(symbol-sexp type-name)
       type-name]
      [(node (cons (symbol-sexp type-name) _))
       type-name]
      [_ (panic #"Bad type-name/vars")]))

  (define (extract-type-vars [sexp : Sexp]) : (Maybe (List Bytes))
    (case sexp
      [(symbol-sexp _)
       (nothing)]
      [(node (cons _ type-var-sexps))
       (just (map parse-type-var-symbol type-var-sexps))]
      [_ (panic #"Bad type-name/vars")]))

  (define (parse-type-var-symbol [sexp : Sexp]) : Bytes
    (case sexp
      [(symbol-sexp bytes) bytes]
      [_ (panic #"Not a valid type variable")]))


  (define (parse-pre-type [sexp : Sexp]) : PreType
    (case sexp
      [(symbol-sexp v) (var-pre-type v)]
      ;; TODO Make function parsing better
      [(node (cons arg (cons (symbol-sexp #"->") (cons result (empty)))))
       (fun-pre-type (empty) (cons (parse-pre-type arg) (empty)) (parse-pre-type result))]
      [(node (cons (symbol-sexp constructor) args))
       (type-app-pre-type constructor (map parse-pre-type args))]
      [_ (panic #"Not a valid Type")]))

  (define (parse-function-definition [sexp : Sexp]) : FunctionDefinition
    (case sexp
      [(node (cons (symbol-sexp #"define")
                   (cons (node type-vars)
                         (cons (node (cons (symbol-sexp function-name) args))
                               (cons (symbol-sexp #":")
                                     (cons result-type (cons body (empty))))))))
       (function-definition
         function-name
         (fun-pre-type
           (map parse-type-var-symbol type-vars)
           (map parse-arg-type args)
           (parse-pre-type result-type))
         (map parse-arg-name args)
         body)]
      [(node (cons (symbol-sexp #"define")
                   (cons (node (cons (symbol-sexp function-name) args))
                         (cons (symbol-sexp #":")
                               (cons result-type (cons body (empty)))))))
       (function-definition
         function-name
         (fun-pre-type
           (empty)
           (map parse-arg-type args)
           (parse-pre-type result-type))
         (map parse-arg-name args)
         body)]
      [_ (panic #"Not a valid function definition")]))

  (define (parse-arg-type [sexp : Sexp]) : PreType
    (case sexp
      [(node (cons (symbol-sexp _) (cons (symbol-sexp #":") (cons type (empty)))))
       (parse-pre-type type)]
      [_ (panic #"Not a valid argument")]))
  (define (parse-arg-name [sexp : Sexp]) : Bytes
    (case sexp
      [(node (cons (symbol-sexp name) (cons (symbol-sexp #":") (cons _ (empty)))))
       name]
      [_ (panic #"Not a valid argument")]))

  (define (parse-module [sexp : Sexp]) : (Either Bytes Module)
    (case sexp
      [(node (cons (symbol-sexp #"module")
                   (cons (symbol-sexp name)
                         (cons imports
                               (cons exports
                                     (cons types
                                           definitions))))))
       (right
         (module name
                 (unparsed-imports imports)
                 (parse-exports/top exports)
                 (parse-types/top types)
                 (map parse-function-definition definitions)))]
      [_ (left #"Bad module form")]))


  (define (a) (extract-either [either : (Either Bytes a)]) : a
    (case either
      [(right v) v]
      [(left b) (panic b)]))

  (define (main [stdin : InputPort] [stdout : OutputPort] [stderr : OutputPort]) : Byte
    (case (parse-module (extract-either (parse-sexp (read-all-bytes stdin))))
      [(right _) 0]
      [(left bytes)
       (begin
         (write-all-bytes bytes stderr)
         1)])))

